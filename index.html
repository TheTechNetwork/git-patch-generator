<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Git-Compatible Patch Generator</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    textarea, input { width: 100%; margin-bottom: 1rem; font-family: monospace; }
    textarea { height: 150px; }
    pre { background: #f4f4f4; padding: 1rem; white-space: pre-wrap; word-wrap: break-word; }
    button { padding: 0.5rem 1rem; margin-top: 0.5rem; margin-right: 0.5rem; }
  </style>
</head>
<body>
  <h2>Git-Compatible Patch Generator</h2>

  <label>Full File Path in Repo (e.g., src/installer/constants.cc):</label>
  <input id="fullpath" type="text" placeholder="src/installer/constants.cc" />

  <label>Original Text:</label>
  <textarea id="original" placeholder="Paste original file content here..."></textarea>

  <label>Modified Text:</label>
  <textarea id="modified" placeholder="Paste modified file content here..."></textarea>

  <button onclick="generateGitPatch()">Generate Git Patch</button>

  <div style="margin-top: 1.5rem;">
    <button onclick="copyPatch()">Copy to Clipboard</button>
    <button onclick="downloadPatch()">Download .patch</button>
  </div>

  <h3>Generated Patch:</h3>
  <pre id="output"></pre>

  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
  <script>
    let currentPatch = '';

    async function sha1(text) {
      const buffer = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-1', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function addNoNewlineMarkers(patch, originalMissingNewline, modifiedMissingNewline) {
      const lines = patch.split('\n');
      let i = 0;
      while (i < lines.length) {
        if (lines[i].startsWith('@@')) {
          for (let j = i + 1; j < lines.length; j++) {
            if (lines[j].startsWith('@@') || lines[j].startsWith('diff --git')) break;
            if (j === lines.length - 1 || lines[j + 1].startsWith('@@') || lines[j + 1].startsWith('diff --git')) {
              if (lines[j].startsWith('-') && originalMissingNewline) {
                lines.splice(j + 1, 0, '\\ No newline at end of file');
              } else if (lines[j].startsWith('+') && modifiedMissingNewline) {
                lines.splice(j + 1, 0, '\\ No newline at end of file');
              }
              break;
            }
          }
        }
        i++;
      }
      return lines.join('\n');
    }

    async function generateGitPatch() {
      const fullPath = document.getElementById('fullpath').value.trim().replace(/^\/|\/$/g, '');
      const original = document.getElementById('original').value;
      const modified = document.getElementById('modified').value;

      if (!fullPath) {
        alert('Please enter a full file path (e.g., src/installer/constants.cc).');
        return;
      }

      const oldHash = await sha1(original);
      const newHash = await sha1(modified);
      const indexLine = `index ${oldHash.slice(0, 7)}..${newHash.slice(0, 7)} 100644`;

      // Create diff chunk only (strip unified diff header)
      let diffChunk = Diff.createPatch(fullPath, original, modified, '', '');
      const lines = diffChunk.split('\n');

      // Remove Index: and === lines from top
      lines.splice(0, 2);

      // Replace file headers with git-style
      lines[0] = `--- a/${fullPath}`;
      lines[1] = `+++ b/${fullPath}`;

      // Inject Git headers
      lines.unshift(indexLine);
      lines.unshift(`diff --git a/${fullPath} b/${fullPath}`);

      const originalMissingNewline = !original.endsWith('\n');
      const modifiedMissingNewline = !modified.endsWith('\n');
      let patch = lines.join('\n');
      patch = addNoNewlineMarkers(patch, originalMissingNewline, modifiedMissingNewline);

      currentPatch = patch;
      document.getElementById('output').textContent = currentPatch;
    }

    function copyPatch() {
      if (!currentPatch) return;
      navigator.clipboard.writeText(currentPatch).then(() => {
        alert('Patch copied to clipboard!');
      });
    }

    function downloadPatch() {
      if (!currentPatch) return;
      const blob = new Blob([currentPatch], { type: 'text/x-patch' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'change.patch';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>